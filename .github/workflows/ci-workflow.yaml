name: CI/CD for WebApplication3

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v3

      - name: üß∞ Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: üß± Restore & Build
        run: |
          dotnet restore WebApplication3.sln
          dotnet build WebApplication3.sln --configuration Release --no-restore

      - name: üß™ Run tests
        run: dotnet test WebApplication3.sln --no-build --verbosity normal

      - name: üöÄ Start Minikube
        uses: medyagh/setup-minikube@latest

      - name: ‚úÖ Verify Minikube is running
        run: |
          minikube start --driver=docker --wait=all
          minikube status

      - name: üê≥ Build Docker images inside Minikube
        run: |
          export SHELL=/bin/bash
          eval $(minikube -p minikube docker-env) || { echo "‚ùå Failed to use Minikube Docker"; exit 1; }

          docker build -t blazorapp1:latest -f BlazorApp1/Dockerfile .
          docker build -t efc:latest -f efc/Dockerfile .
          docker build -t webapplication3:latest -f WebApplication3/Dockerfile .

      - name: üì¶ Apply Kubernetes manifests
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl apply -f pvc-dataprotection.yaml

      - name: üïí Wait for rollout (best-effort)
        run: |
          kubectl rollout status deployment/blazorapp-deployment --timeout=60s || true
          kubectl rollout status deployment/efc-deployment --timeout=60s || true
          kubectl rollout status deployment/webapplication3-deployment --timeout=60s || true

      - name: üåê Test service endpoint
        run: |
          kubectl port-forward service/webapplication3-service 8080:80 &> /dev/null &
          sleep 5
          curl -i http://localhost:8080/Posts || echo "‚ö†Ô∏è Swagger not available"
